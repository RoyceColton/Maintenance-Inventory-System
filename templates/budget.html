{% extends "base.html" %}
{% block title %}Budget Report{% endblock %}
{% block content %}

<div class="card">
  <div class="card-body">
    <h1>Budget Tracker</h1>

    <!-- Quarter Switcher -->
    <div class="mb-3">
      <strong>View by Quarter:</strong>
      {% for q in range(1, 5) %}
        <a href="{{ url_for('budget') }}?q={{ q }}" class="btn btn-sm {% if q == current_quarter %}btn-primary{% else %}btn-outline-primary{% endif %}">
          Q{{ q }}
        </a>
      {% endfor %}
    </div>

    <p><strong>Current View:</strong> {{ quarter_label }}</p>
    <p><strong>Quarter Date Range:</strong> {{ quarter_range }}</p>

    <p><strong>Total Budget:</strong> ${{ overall_budget }}</p>

    <p>
      <strong>Total Spent:</strong>
      <span class="{% if is_over %}text-danger{% else %}text-success{% endif %}" style="font-weight: bold;">
        ${{ spent_total }}
      </span>
    </p>

    {% if is_over %}
      <p class="text-danger"><strong>Over Budget By:</strong> ${{ over_budget }}</p>
    {% endif %}

    <hr>
    <h4>Budget Usage</h4>
    <div class="progress" style="height: 30px;">
      <div class="progress-bar {% if is_over %}bg-danger{% else %}bg-success{% endif %}" 
           role="progressbar" 
           style="width: {{ percent_spent }}%;" 
           aria-valuenow="{{ percent_spent }}" 
           aria-valuemin="0" 
           aria-valuemax="100">
        {{ percent_spent }}%
      </div>
    </div>

    <hr>
    <h4>Expense Line Usage</h4>
    <canvas id="lineChart" height="100"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const ctx = document.getElementById('lineChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Appliances', 'Furniture', 'Misc'],
          datasets: [{
            label: 'Spent ($)',
            data: [{{ line1_spent }}, {{ line2_spent }}, {{ line3_spent }}],
            backgroundColor: [
              'rgba(75, 192, 192, 0.6)',
              'rgba(255, 159, 64, 0.6)',
              'rgba(153, 102, 255, 0.6)'
            ],
            borderColor: [
              'rgba(75, 192, 192, 1)',
              'rgba(255, 159, 64, 1)',
              'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    </script>

    <hr>
    <p><strong>Appliances:</strong> ${{ expense_line1 }}</p>
    <p><strong>Furniture:</strong> ${{ expense_line2 }}</p>
    <p><strong>Misc:</strong> ${{ expense_line3 }}</p>

    <p class="text-muted mt-4">* This data is based on purchases delivered during the selected quarter.</p>
  </div>
</div>

{% endblock %}
