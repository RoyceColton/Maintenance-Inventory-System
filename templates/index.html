{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="card">
  <div class="card-body">
    <h1 class="mb-4">Inventory Dashboard</h1>
    
    <!-- Search and Filter Form -->
    <form method="get" class="form-inline mb-4">
      <input type="text" name="search" class="form-control mr-2" placeholder="Search by name or part number" value="{{ search }}">
      <select name="room" class="form-control mr-2" id="roomSelect">
        <option value="">All Rooms</option>
        {% for room in rooms.keys() %}
          <option value="{{ room }}" {% if room == selected_room %}selected{% endif %}>{{ room }}</option>
        {% endfor %}
      </select>
      <select name="appliance" class="form-control mr-2" id="applianceSelect">
        <option value="">All Appliances</option>
        {% if selected_room and rooms[selected_room] %}
          {% for appliance in rooms[selected_room] %}
            <option value="{{ appliance }}" {% if appliance == selected_appliance %}selected{% endif %}>{{ appliance }}</option>
          {% endfor %}
        {% endif %}
      </select>
      <button type="submit" class="btn btn-primary">Search</button>
    </form>
    
    <!-- Link to Combined Orders & History Page -->
    <a href="{{ url_for('combined_orders') }}" class="btn btn-warning mb-4">Orders & History</a>
    
    {% if alerts %}
      <div class="alert alert-warning">
        <strong>Low Stock Alerts:</strong>
        <ul>
          {% for part in alerts %}
            <li>{{ part.name }} ({{ part.count }} in stock, threshold: {{ part.threshold }})</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    
    <!-- All Parts Section -->
    <h2>All Parts</h2>
    {% if parts|length > 0 %}
      <table class="table table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Model</th>
            <th>Count</th>
            <th>Cost</th>
            <th>Room</th>
            <th>Appliance</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for part in parts %}
            <tr id="part-row-{{ part.id }}">
              <td>{{ part.id }}</td>
              <td>{{ part.name }}</td>
              <td>{{ part.model_number }}</td>
              <td>
                <span class="part-count" id="part-count-{{ part.id }}">{{ part.count }}</span>
              </td>
              <td>{{ part.cost }}</td>
              <td>{{ part.room }}</td>
              <td>{{ part.appliance_type }}</td>
              <td>
                <a href="{{ url_for('update_part', part_id=part.id) }}" class="btn btn-sm btn-primary">Edit</a>
                <form action="{{ url_for('delete_part', part_id=part.id) }}" method="post" style="display:inline;">
                  <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?');">Delete</button>
                </form>
                <!-- Plus and minus buttons for inline stock updates -->
                <button class="btn btn-sm btn-success increment-btn" data-id="{{ part.id }}">+</button>
                <button class="btn btn-sm btn-warning decrement-btn" data-id="{{ part.id }}">-</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No parts found.</p>
    {% endif %}
    
    <div class="text-center my-4">
      <a href="{{ url_for('add_part') }}" class="btn btn-primary btn-extra-large">Add Part</a>
    </div>
  </div>
</div>

<script>
(function() {
  function updateCountDisplay(partId, newCount) {
    document.getElementById('part-count-' + partId).textContent = newCount;
  }
  document.querySelectorAll('.increment-btn').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const partId = this.getAttribute('data-id');
      fetch(`/api/increment/${partId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateCountDisplay(partId, data.new_count);
          } else {
            alert(data.error || 'Failed to increment count.');
          }
        })
        .catch(error => console.error('Error:', error));
    });
  });
  document.querySelectorAll('.decrement-btn').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const partId = this.getAttribute('data-id');
      fetch(`/api/decrement/${partId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateCountDisplay(partId, data.new_count);
          } else {
            alert(data.error || 'Failed to decrement count.');
          }
        })
        .catch(error => console.error('Error:', error));
    });
  });
})();
</script>

<script>
(function() {
  const roomSelect = document.getElementById("roomSelect");
  const applianceSelect = document.getElementById("applianceSelect");
  const roomsData = {{ rooms|tojson|safe }};
  roomSelect.addEventListener("change", function() {
    const room = this.value;
    applianceSelect.innerHTML = '<option value="">All Appliances</option>';
    if (room && roomsData[room]) {
      roomsData[room].forEach(function(appliance) {
        const option = document.createElement("option");
        option.value = appliance;
        option.text = appliance;
        applianceSelect.appendChild(option);
      });
    }
  });
})();
</script>
{% endblock %}
